<!DOCTYPE html>
<html lang="ko">

<head>
  <%- include ("../partials/header.ejs") %>
  <style>
    @font-face {
      font-family: "ubuntu";
      src: url("/font/Ubuntu-Bold.ttf") format("truetype");
    }
  </style>
</head>

<body class="layout-boxed remove-alt-menu">

  <%- include ("../partials/loader.ejs") %>

  <%- include ("../partials/nav.ejs") %>
  <div>

  </div>
  <!--  BEGIN MAIN CONTAINER  -->
  <div class="main-container sidebar-closed " id="container">

    <div class="overlay"></div>
    <div class="search-overlay"></div>

    <%- include ("../partials/sidebar.ejs") %>

    <!--  BEGIN CONTENT AREA  -->
    <div id="content" class="main-content">
      <div class="layout-px-spacing">

        <div class="middle-content container-xxl p-0">
          <!-- BREADCRUMB -->
          <div class="page-meta">
            <nav class="breadcrumb-style-one" aria-label="breadcrumb">
              <ol class="breadcrumb">
                <li class="breadcrumb-item"><a href="/disposalClients">폐차 고객 관리</a>
                </li>
                <li class="breadcrumb-item active" aria-current="page">
                  <%= process.carNum %>
                </li>
                <li class="breadcrumb-item active" aria-current="page">수정</li>
              </ol>
            </nav>
          </div>
          <!-- /BREADCRUMB -->

          <!-- 고객 정보 -->
          <div class="row layout-spacing">
            <div class="col-lg-12 layout-top-spacing">
              <div class="col-lg-12">
                <div class="statbox widget box box-shadow">
                  <div class="widget-header">
                    <div class="row layout-top-spacing">
                      <div class="col col-xl-8 mb-xl-0 mb-2">
                        <h3 class="text-center">고객 및 차량 정보</h3>
                      </div>
                    </div>
                  </div>
                  <div class="widget-content widget-content-area">
                    <form id="clientInfo" method="post" action="/process/edit/<%= process.carNum %>">
                      <div class="form-group row">
                        <div class="row">
                          <div class="col col-xl-4 mb-xl-0 mb-2">
                            <h6>성함</h6>
                          </div>
                          <div class="col col-xl-4 mb-xl-0 mb-2">
                            <h6>연락처</h6>
                          </div>
                        </div>
                        <div class="row layout-spacing">
                          <div class="col col-xl-4 mb-xl-0 mb-2">
                            <div class="form-group">
                              <input disabled id="clientName" type="text" name="clientName" placeholder="" class="form-control" value="<%= clients.clientName %>">
                            </div>
                          </div>
                          <div class="col col-xl-4 mb-xl-0 mb-2">
                            <div class="form-group">
                              <input disabled id="phoneNum" type="text" name="phoneNum" placeholder="" class="form-control" value="<%= clients.phoneNum %>">
                            </div>
                          </div>
                        </div>
                      </div>

                      <div class="form-group row">
                        <div class="row">
                          <div class="col col-xl-4 mb-xl-0 mb-2">
                            <h6>E-mail</h6>
                          </div>
                        </div>
                        <div class="row layout-spacing">
                          <div class="col col-xl-8 mb-xl-0 mb-2">
                            <div class="form-group">
                              <input disabled id="email" type="text" name="email" placeholder="" class="form-control" value="<%= clients.email %>">
                            </div>
                          </div>
                        </div>
                      </div>

                      <!-- 고객 차량 정보 -->
                      <div class="form-group row">
                        <div class="row">
                          <div class="col col-xl-4 mb-xl-0 mb-2">
                            <h6>차량번호</h6>
                          </div>
                          <div class="col col-xl-4 mb-xl-0 mb-2">
                            <h6>차종</h6>
                          </div>
                        </div>
                        <div class="row layout-spacing">
                          <div class="col col-xl-4 mb-xl-0 mb-2">
                            <div class="form-group">
                              <input disabled id="carNum" type="text" name="carNum" placeholder="" class="form-control" value="<%= process.carNum %>">
                            </div>
                          </div>
                          <div class="col col-xl-4 mb-xl-0 mb-2">
                            <div class="form-group">
                              <input disabled id="model" type="text" name="model" placeholder="" class="form-control" value="<%= process.model %>">
                            </div>
                          </div>
                        </div>
                      </div>

                      <div class="form-group row">
                        <div class="row">
                          <div class="col col-xl-4 mb-xl-0 mb-2">
                            <h6>원동기 형식</h6>
                          </div>
                          <div class="col col-xl-4 mb-xl-0 mb-2">
                            <h6>배기량</h6>
                          </div>
                        </div>
                        <div class="row layout-spacing">
                          <div class="col col-xl-4 mb-xl-0 mb-2">
                            <div class="form-group">
                              <input disabled id="detailModel" type="text" name="detailModel" placeholder="" class="form-control" value="<%= process.detailModel %>">
                            </div>
                          </div>
                          <div class="col col-xl-4 mb-xl-0 mb-2">
                            <div class="form-group">
                              <input disabled id="displacement" type="text" name="displacement" placeholder="" class="form-control" value="<%= process.displacement %>">
                            </div>
                          </div>
                        </div>
                      </div>

                      <div class="form-group row">
                        <div class="row">
                          <div class="col col-xl-4 mb-xl-0 mb-2">
                            <h6>연식</h6>
                          </div>
                          <div class="col col-xl-4 mb-xl-0 mb-2">
                            <h6>최초등록일</h6>
                          </div>
                        </div>
                        <div class="row layout-spacing">
                          <div class="col col-xl-4 mb-xl-0 mb-2">
                            <div class="form-group">
                              <input disabled id="yearModel" type="text" name="yearModel" placeholder="" class="form-control" value="<%= process.yearModel %>">
                            </div>
                          </div>
                          <div class="col col-xl-4 mb-xl-0 mb-2">
                            <div class="form-group">
                              <input disabled id="registerDate" type="text" name="registerDate" placeholder="" class="form-control" value="<%= myUtils.formatDate(process.registerDate) %>">
                            </div>
                          </div>
                        </div>
                      </div>

                      <div class="form-group row">
                        <div class="row">
                          <div class="col col-xl-4 mb-xl-0 mb-2">
                            <h6>차종명</h6>
                          </div>
                          <div class="col col-xl-4 mb-xl-0 mb-2">
                            <h6>사용연료명</h6>
                          </div>
                        </div>
                        <div class="row layout-spacing">
                          <div class="col col-xl-4 mb-xl-0 mb-2">
                            <div class="form-group">
                              <input disabled id="carType" type="text" name="carType" placeholder="" class="form-control" value="<%= process.carType %>">
                            </div>
                          </div>
                          <div class="col col-xl-4 mb-xl-0 mb-2">
                            <div class="form-group">
                              <input disabled id="useFuelName" type="text" name="useFuelName" placeholder="" class="form-control" value="<%= process.useFuelName %>">
                            </div>
                          </div>
                        </div>
                      </div>

                      <div class="form-group row">
                        <div class="row">
                          <div class="col col-xl-4 mb-xl-0 mb-2">
                            <h6>등록상세명</h6>
                          </div>
                          <div class="col col-xl-4 mb-xl-0 mb-2">
                            <h6>승차정원수</h6>
                          </div>
                        </div>
                        <div class="row layout-spacing">
                          <div class="col col-xl-4 mb-xl-0 mb-2">
                            <div class="form-group">
                              <input disabled id="registDetailName" type="text" name="registDetailName" placeholder="" class="form-control" value="<%= process.registDetailName %>">
                            </div>
                          </div>
                          <div class="col col-xl-4 mb-xl-0 mb-2">
                            <div class="form-group">
                              <input disabled id="maxPerson" type="number" name="maxPerson" placeholder="" class="form-control" value="<%= process.maxPerson %>">
                            </div>
                          </div>
                        </div>
                      </div>

                      <div class="form-group row">
                        <div class="row">
                          <div class="col col-xl-4 mb-xl-0 mb-2">
                            <h6>차량중량</h6>
                          </div>
                          <div class="col col-xl-4 mb-xl-0 mb-2">
                            <h6>차량총중량</h6>
                          </div>
                        </div>
                        <div class="row layout-spacing">
                          <div class="col col-xl-4 mb-xl-0 mb-2">
                            <div class="form-group">
                              <input disabled id="carWeight" type="text" name="carWeight" placeholder="" class="form-control" value="<%= process.carWeight %>">
                            </div>
                          </div>
                          <div class="col col-xl-4 mb-xl-0 mb-2">
                            <div class="form-group">
                              <input disabled id="carTotalWeight" type="text" name="carTotalWeight" placeholder="" class="form-control" value="<%= process.carTotalWeight %>">
                            </div>
                          </div>
                        </div>
                      </div>

                      <div class="form-group row">
                        <div class="row">
                          <div class="col col-xl-4 mb-xl-0 mb-2">
                            <h6>실거주지</h6>
                          </div>
                        </div>
                        <div class="row layout-spacing">
                          <div class="col col-xl-8 mb-xl-0 mb-2">
                            <div class="form-group">
                              <input disabled id="address" type="text" name="address" placeholder="" class="form-control" value="<%= clients.address %>">
                            </div>
                          </div>
                        </div>
                      </div>

                      <div class="form-group row">
                        <div class="row">
                          <div class="col col-xl-4 mb-xl-0 mb-2">
                            <h6>차량상태</h6>
                          </div>
                          <div class="col col-xl-4 mb-xl-0 mb-2">
                            <h6>알루미늄 휠</h6>
                          </div>
                        </div>
                        <div class="row layout-spacing">
                          <div class="col col-xl-4 mb-xl-0 mb-2">
                            <div class="form-group">
                              <label for="carCondition" class="visually-hidden">Text</label>
                              <select class="form-select" id="carCondition" name="carCondition">
                                <% for(let i=0; i< codezip.carCondition.length; i++) { %>
                                <% if(process.carCondition==i) { %>
                                <option value="<%= i %>" selected>
                                  <%= codezip.carCondition[i] %>
                                </option>
                                <% } else { %>
                                <option value="<%= i %>">
                                  <%= codezip.carCondition[i] %>
                                </option>
                                <% } %>
                                <% } %>
                              </select>
                            </div>
                          </div>
                          <div class="col col-xl-4 mb-xl-0 mb-2">
                            <div class="form-group">
                              <label for="aluminumWheel" class="visually-hidden">Text</label>
                              <select class="form-select" id="aluminumWheel" name="aluminumWheel">
                                <% for(let i=0; i< codezip.aluminumWheel.length; i++) { %>
                                <% if(process.aluminumWheel==i) { %>
                                <option value="<%= i %>" selected>
                                  <%= codezip.aluminumWheel[i] %>
                                </option>
                                <% } else { %>
                                <option value="<%= i %>">
                                  <%= codezip.aluminumWheel[i] %>
                                </option>
                                <% } %>
                                <% } %>
                              </select>
                            </div>
                          </div>
                        </div>
                      </div>

                      <div class="form-group row">
                        <div class="row">
                          <div class="col col-xl-4 mb-xl-0 mb-2">
                            <h6>압류</h6>
                          </div>
                          <div class="col col-xl-4 mb-xl-0 mb-2">
                            <h6>저당</h6>
                          </div>
                        </div>
                        <div class="row layout-spacing col-xl-8">
                          <div class="col mb-xl-0 mb-2 row">
                            <div class="col form-group d-flex">
                              <label for="attachment" class="visually-hidden">Text</label>
                              <input class="p-2 flex-grow-1 form-control" id="attachment" name="attachment" value="<%= process.attachment %>">
                              <h6 class="p-2 align-self-end">
                                건</h6>
                            </div>
                          </div>
                          <div class="col mb-xl-0 mb-2 row">
                            <div class="col form-group d-flex">
                              <label for="mortgage" class="visually-hidden">Text</label>
                              <input class="p-2 form-control" id="mortgage" name="mortgage" value="<%= process.mortgage %>">
                              <h6 class="p-2 align-self-end">
                                건</h6>
                            </div>
                          </div>
                        </div>
                      </div>

                      <div class="row layout-top-spacing">
                        <div class="col">
                          <div class="form-group ">
                            <button class="btn btn-outline-success me-3">저장</button>
                            <button type="button" onclick="cancel()" class="btn btn-outline-danger me-3">취소</button>
                          </div>
                        </div>
                      </div>
                    </form>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- 진행상황 -->
          <div class="row layout-spacing">
            <div class="col-lg-12 layout-top-spacing">
              <div class="col-lg-12">
                <div class="statbox widget box box-shadow">
                  <div class="widget-header">
                    <div class="row layout-top-spacing">
                      <div class="col col-xl-8 mb-xl-0 mb-2">
                        <h3 class="text-center">진행상황</h3>
                      </div>
                    </div>
                  </div>
                  <div class="widget-content widget-content-area">
                    <form id="process" method="post" action="/process/edit/<%= process.carNum %>">
                      <div class="form-group d-flex">
                        <div class="p-2 mb-xl-1 mb-4 align-self-center">
                          <h6>진행단계</h6>
                        </div>
                        <div class="p-2 mb-xl-1 mb-4">
                          <select class="form-select" type="text" id="state" name="state">
                            <% for(code in codezip.disposalStateCode2Text) { %>
                            <% if (process.state==code) { %>
                            <option value="<%= code %>" selected>
                              <%= codezip.disposalStateCode2Text[code] %>
                            </option>
                            <% } else { %>
                            <option value="<%= code %>">
                              <%= codezip.disposalStateCode2Text[code] %>
                            </option>
                            <% } %>
                            <% } %>
                          </select>
                        </div>
                      </div>

                      <div class="form-group row">
                        <div class="row">
                          <div class="col col-xl-4 mb-xl-0 mb-2">
                            <h6>가견적 발송 날짜</h6>
                          </div>
                          <div class="col col-xl-4 mb-xl-0 mb-2">
                            <h6>가견적 확인 날짜</h6>
                          </div>
                        </div>
                        <div class="row layout-spacing">
                          <div class="col col-xl-4 mb-xl-0 mb-2">
                            <div class="form-group">
                              <input class="input-date form-control" type="text" name="date1" disabled value="<%= myUtils.formatDate(process.date1) %>">
                            </div>
                          </div>
                          <div class="col col-xl-4 mb-xl-0 mb-2">
                            <div class="form-group">
                              <input class="input-date form-control" type="text" name="date2" disabled value="<%= myUtils.formatDate(process.date2) %>">
                            </div>
                          </div>
                        </div>
                      </div>

                      <div class="form-group row">
                        <div class="row">
                          <div class="col col-xl-4 mb-xl-0 mb-2">
                            <h6>인수 완료 날짜</h6>
                          </div>
                          <div class="col col-xl-4 mb-xl-0 mb-2">
                            <h6>실견적 발송 날짜</h6>
                          </div>
                        </div>
                        <div class="row layout-spacing">
                          <div class="col col-xl-4 mb-xl-0 mb-2">
                            <div class="form-group">
                              <input class="input-date form-control" type="text" name="date3" value="<%= myUtils.formatDate(process.date3) %>">
                            </div>
                          </div>
                          <div class="col col-xl-4 mb-xl-0 mb-2">
                            <div class="form-group">
                              <input class="input-date form-control" type="text" name="date4" value="<%= myUtils.formatDate(process.date4) %>" disabled>
                            </div>
                          </div>
                        </div>
                      </div>

                      <div class="form-group row">
                        <div class="row">
                          <div class="col col-xl-4 mb-xl-0 mb-2">
                            <h6>실견적 확인 날짜</h6>
                          </div>
                          <div class="col col-xl-4 mb-xl-0 mb-2">
                            <h6>폐차 완료 날짜</h6>
                          </div>
                        </div>
                        <div class="row layout-spacing">
                          <div class="col col-xl-4 mb-xl-0 mb-2">
                            <div class="form-group">
                              <input class="input-date form-control" type="text" name="date5" value="<%= myUtils.formatDate(process.date5) %>" disabled>
                            </div>
                          </div>
                          <div class="col col-xl-4 mb-xl-0 mb-2">
                            <div class="form-group">
                              <input class="input-date form-control" type="text" name="date6" value="<%= myUtils.formatDate(process.date6) %>">
                            </div>
                          </div>
                        </div>
                      </div>



                      <div class="row layout-top-spacing">
                        <div class="col">
                          <div class="form-group ">
                            <button class="btn btn-outline-success me-3">저장</button>
                            <button type="button" onclick="cancel()" class="btn btn-outline-danger me-3">취소</button>
                          </div>
                        </div>
                      </div>
                    </form>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- 가견적 -->
          <div class="row layout-spacing">
            <div class="col-lg-12 layout-top-spacing">
              <div class="col-lg-12">
                <div class="statbox widget box box-shadow">
                  <div class="widget-header">
                    <div class="row layout-top-spacing">
                      <div class="col col-xl-8 mb-xl-0 mb-2">
                        <h3 class="text-center">가견적</h3>
                      </div>
                    </div>
                  </div>
                  <div class="widget-content widget-content-area">
                    <form id="estimation" method="post" action="/process/edit/<%= process.carNum %>">
                      <div class="row">
                        <h6>수출 가능여부
                          <span>
                            <% if (process.exportable) { %>
                            <input type="checkbox" name="exportable" checked>
                            <% } else { %>
                            <input type="checkbox" name="exportable">
                            <% } %>
                          </span>
                        </h6>
                      </div>
                      <div class="form-group d-flex col-xl-8">
                        <h6 class="p-2 align-self-end">견적가</h6>
                        <div class="p-2">
                          <% if(process.state==1) { %>
                          <input class="form-control" name="estimation" value="<%= process.estimation %>">
                          <% }else{ %>
                          <input class="form-control" name="estimation" value="<%= process.estimation %>" readonly>
                          <% } %>
                        </div>
                        <h6 class="p-2 align-self-end">원</h6>
                      </div>

                      <% if(process.state==1) { %>
                      <div class="row layout-top-spacing">
                        <div class="col">
                          <div class="form-group align-self-center">
                            <button class="btn btn-outline-success me-3">저장</button>
                          </div>
                        </div>
                      </div>
                      <% } %>

                    </form>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- 실견적 -->
          <div class="row layout-spacing">
            <div class="col-lg-12 layout-top-spacing">
              <div class="col-lg-12">
                <div class="statbox widget box box-shadow">
                  <div class="widget-header">
                    <div class="row layout-top-spacing">
                      <div class="col col-xl-8 mb-xl-0 mb-2">
                        <h3 class="text-center">실견적</h3>
                      </div>
                    </div>
                  </div>
                  <div class="widget-content widget-content-area">
                    <form id="quotation">
                      <div class="form-group d-flex col-xl-8">
                        <h6 class="p-2 align-self-end">견적가</h6>
                        <div class="p-2">
                          <% if(process.state==5) { %>
                          <input class="form-control" id="quotation_price" name="quotation" value="<%= process.quotation %>">
                          <% }else{ %>
                          <input class="form-control" id="quotation_price" name="quotation" value="<%= process.quotation %>" readonly>
                          <% } %>
                        </div>
                        <h6 class="p-2 align-self-end">원</h6>
                        <% if(process.state==5) { %>
                        <div class="p-2 form-group align-self-center">
                          <button class="btn btn-outline-success me-3">저장</button>
                        </div>
                        <% } %>
                      </div>
                    </form>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- 최종견적서 -->
          <div class="row layout-spacing">
            <div class="col-lg-12 layout-top-spacing">
              <div class="col-lg-12">
                <div class="statbox widget box box-shadow">
                  <div class="widget-header">
                    <div class="row layout-top-spacing">
                      <div class="col col-xl-8 mb-xl-0 mb-2">
                        <h3 class="text-center">최종견적서</h3>
                      </div>
                    </div>
                  </div>
                  <div class="widget-content widget-content-area">
                    <!-- <button type="button" onclick="showImage();">확인용</button> -->
                    <div class="col-xl-8">
                      <% if(process.finalProcessPath) { %>
                      <img class="img-fluid" src="/<%= process.finalProcessPath %>" />
                      <% } %>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- 말송증 등록 -->
          <div class="row layout-spacing">
            <div class="col-lg-12 layout-top-spacing">
              <div class="col-lg-12">
                <div class="statbox widget box box-shadow">
                  <div class="widget-header">
                    <div class="row layout-top-spacing">
                      <div class="col col-xl-8 mb-xl-0 mb-2">
                        <h3 class="text-center">말소증</h3>
                      </div>
                    </div>
                  </div>
                  <div class="widget-content widget-content-area">
                    <form id="deregistration" method="POST" action="/process/deregistrationPath/<%= process.carNum %>" enctype="multipart/form-data">
                      <div class="d-flex col-xl-8">
                        <div class="p-2 flex-grow-1">
                          <input id="deregistrationInput" type="file" class="form-control-file" name="deregistrationPath">
                        </div>
                        <div class="p-2">
                          <button class="btn btn-primary">올리기</button>
                        </div>
                      </div>
                    </form>
                    <div id="deregistrationImg" class="col-xl-8">
                      <% if(process.deregistrationPath) { %>
                      <img class="img-fluid" src="/<%= process.deregistrationPath %>" />
                      <% } %>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>

        </div>
      </div>

      <%- include ("../partials/footer.ejs") %>

    </div>
    <!--  END CONTENT AREA  -->
  </div>
  <!-- END MAIN CONTAINER -->

  <!-- REQUEST PREVIEW -->
  <div id="req_table" style="width: 12cm; font-family:'ubuntu';">

  </div>
  <%- include ("../partials/commonScrpits.ejs") %>

  <!-- BEGIN PAGE LEVEL PLUGINS/CUSTOM SCRIPTS -->
  <script>
    $(function() {
      $(".input-date").datepicker({});
    });
  </script>
  <!-- <script>
    const finalProcessInput = document.getElementById('finalProcessInput');
    finalProcessInput.addEventListener('change', (event) => {
      console.log(event.target)
      loadFile(event.target)
    })

    function loadFile(input) {
      var file = input.files[0];
      $('#finalProcessImg').html(" <img class='form-control' src='" + URL.createObjectURL(file) + "'/> ");
    }

    finalProcess.onsubmit = async (e) => {
      e.preventDefault();

      if (!finalProcess[0].value) return alert("파일을 선택해주세요.");

      let response = await fetch(finalProcess.action, {
        method: 'POST',
        body: new FormData(finalProcess)
      }).then(res => {
        if (res.ok) {
          alert("저장되었습니다.");
          window.location.reload();
        } else {
          alert("전송 실패!!");
        }
        location.reload();
      });
    }
  </script> -->
  <script>
    const deregistrationInput = document.getElementById('deregistrationInput');
    deregistrationInput.addEventListener('change', (event) => {
      console.log(event.target)
      loadFile2(event.target)
    })

    function loadFile2(input) {
      var file = input.files[0];
      $('#deregistrationImg').html(" <img class='form-control' src='" + URL.createObjectURL(file) + "'/> ");
    }

    deregistration.onsubmit = async (e) => {
      e.preventDefault();

      if (!deregistration[0].value) return alert("파일을 선택해주세요.");

      let response = await fetch(deregistration.action, {
        method: 'POST',
        body: new FormData(deregistration)
      }).then(res => {
        if (res.ok) {
          alert("저장되었습니다.");
          window.location.reload();
        } else {
          alert("전송 실패!!");
        }
        location.reload();
      });
    }
  </script>
  <script>
    estimation.onsubmit = async (e) => {
      e.preventDefault();

      let body = {};
      body.exportable = estimation[0].checked;
      body.estimation = estimation[1].value;
      body.date1 = new Date();
      body.state = 2;
      console.log(body);

      let response = await fetch(estimation.action, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json;charset=utf-8'
        },
        body: JSON.stringify(body)
      }).then(res => {
        if (res.ok) {
          alert("저장되었습니다.");
          window.location.reload();
        } else {
          alert("전송 실패!!");
        }
        location.reload();
      });
    }
  </script>
  <script>
    process.onsubmit = async (e) => {
      e.preventDefault();

      let body = {};
      for (let [name, value] of new FormData(process)) body[name] = value;

      let response = await fetch(process.action, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json;charset=utf-8'
        },
        body: JSON.stringify(body)
      }).then(res => {
        if (res.ok) alert("저장되었습니다.");
        else alert("전송 실패!!");
        location.reload();
      });

    }
  </script>
  <script>
    clientInfo.onsubmit = async (e) => {
      e.preventDefault();

      let body = {};
      for (let [name, value] of new FormData(clientInfo)) body[name] = value;

      let response = await fetch(clientInfo.action, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json;charset=utf-8'
        },
        body: JSON.stringify(body)
      }).then(res => {
        if (res.ok) alert("저장되었습니다.");
        else {
          alert("전송 실패!!");
        }
        location.reload();
      });
    }
  </script>
  <script>
    quotation.onsubmit = async (e) => {
      e.preventDefault();
      let isDarkmode = document.body.classList.contains("dark");
      if (isDarkmode) document.body.classList.remove("dark");

      let body = new FormData();
      body.append("quotation", quotation[0].value);
      body.append("state", 6);
      body.append("date4", new Date());

      const target = document.getElementById('req_table')
      target.innerHTML = req_html();
      await sleep(1);

      domtoimage.toBlob(target)
        .then(function(blob) {
          if (isDarkmode) document.body.classList.add("dark");
          // console.log(blob);
          body.append('finalProcessPath', blob);

          const url = "/process/finalProcess/<%= process.carNum %>";
          fetch(url, {
              method: 'POST',
              body: body
            })
            .then(res => {
              // console.log(res)
              if (res.ok) alert("전송 성공");
              else throw new Error(res.statusText)
            })
            .catch(err => {
              console.error(err)
              alert("전송에 실패하였습니다. 잠시 후에 다시 시도해주십시오.")
            }).finally(() => {
              location.reload();
            });

          target.innerHTML = '';
        });
    }

    function req_data() {
      return {
        "model": model.value, // 차명
        "yearModel": yearModel.value, // 연식
        "displacement": displacement.value, // 배기량
        "detailModel": detailModel.value, // 원동기 형식
        "registerDate": new Date(registerDate.value), // 최초등록일
        "carCondition": carCondition.options[carCondition.selectedIndex].text, // 차량상태
        "aluminumWheel": aluminumWheel.options[aluminumWheel.selectedIndex].text, // 알루미늄 휠
        "attachment": attachment.value, // 압류
        "mortgage": mortgage.value, // 저당
        "quotation": quotation_price.value, // 최종견적가
      }
    }

    function req_html() {
      const data = req_data();
      return `<div class="form-control">
        <div class="row my-3">
          <div class="col"></div>
          <div class="col-8 text-center">
            <h3>최종견적서<h3>
          </div>
          <div class="col">
            <img style="width:1.5cm;" src="/images/mark.png">
          </div>
        </div>
        <table class="table table-bordered ">
            <tr>
                <td class="text-center">차종</td>
                <td class="text-center" colspan="4">
                    ${data.model}
                </td>
              </tr>
              <tr>
                <td class="text-center">연식</td>
                <td class="text-center" colspan="4">
                    ${data.yearModel}년
                </td>
            </tr>
            <tr>
                <td class="text-center">원동기 형식</td>
                <td class="text-center" colspan="4">
                    ${data.detailModel}
                </td>
              </tr>
              <tr>
                <td class="text-center">최초등록일</td>
                <td class="text-center" colspan="4">
                    ${data.registerDate.getFullYear()}년 ${data.registerDate.getMonth()+1}월 ${data.registerDate.getDate()}일
                </td>
              </tr>
              <tr>
                <td class="text-center">배기량</td>
                <td class="text-center" colspan="4">
                    ${Intl.NumberFormat().format(data.displacement)} cc
                </td>
            </tr>
            <tr>
                <td class="text-center">압류/저당</td>
                <td class="text-center" colspan="4">
                    ${data.attachment ? data.attachment : 0} 건 / ${data.mortgage ? data.mortgage : 0} 건
                </td>
              </tr>
              <tr>
                <td class="text-center">차량상태</td>
                <td class="text-center" colspan="4">
                    ${data.carCondition}
                </td>
            </tr>
            <tr>
                <td class="text-center">알루미늄 휠</td>
                <td class="text-center" colspan="4">
                    ${data.aluminumWheel}
                </td>
            </tr>
            <tr>
              <td class="text-center" colspan="5">
                  <div class="mt-4 mb-3">최종견적가 : ${Intl.NumberFormat().format(data.quotation)} 원</div>
                  <div class="text-end" style="font-size:10px">정품촉매 기준가격이며 가품 일시 가격변동 됩니다.</div>
              </td>
          </tr>
        </table>
    </div>`
    }

    function sleep(sec) {
      return new Promise(resolve => setTimeout(resolve, sec * 1000));
    }
  </script>
  <!-- <script>
    async function showImage() {
      let isDarkmode = document.body.classList.contains("dark");
      if (isDarkmode) document.body.classList.remove("dark");

      const target = document.getElementById('req_table');
      target.innerHTML = req_html();
      await sleep(1);

      domtoimage.toBlob(target)
        .then((blob) => {
          let url = URL.createObjectURL(blob);
          window.open(url);
          target.innerHTML = '';
        }).finally(() => {
          if (isDarkmode) document.body.classList.add("dark");
        });

    }
  </script> -->
  <!-- BEGIN PAGE LEVEL PLUGINS/CUSTOM SCRIPTS -->
</body>

</html>